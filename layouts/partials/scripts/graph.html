{{/* Graph initialization script */}}
{{- $baseURL := .Site.BaseURL -}}
{{- $linkIndexPath := printf "%slinkIndex.json" $baseURL -}}
{{- $contentIndexPath := printf "%scontentIndex.json" $baseURL -}}
<script>
  const BASE_URL = {{.Site.BaseURL | jsonify}};
  const fetchData = Promise.all([
    fetch("{{ $linkIndexPath }}")
      .then(response => {
        if (!response.ok) {
          throw new Error(`Failed to fetch linkIndex.json: ${response.status}`);
        }
        return response.json();
      })
      .then(data => ({
        index: data.index || {},
        links: data.links || [],
      }))
      .catch(error => {
        console.error('Error fetching linkIndex.json:', error);
        return { index: {}, links: [] };
      }),
    fetch("{{ $contentIndexPath }}")
      .then(response => {
        if (!response.ok) {
          throw new Error(`Failed to fetch contentIndex.json: ${response.status}`);
        }
        return response.json();
      })
      .catch(error => {
        console.error('Error fetching contentIndex.json:', error);
        return {};
      }),
  ])
  .then(([{index, links}, content]) => ({
    index,
    links,
    content: content || {},
  }))

  const renderGraph = () => {
    const container = document.getElementById("graph-container");
    if (!container) return;

    // Clear any existing graph
    container.textContent = "";

    // Safely parse BASE_URL - handle both absolute and relative URLs
    let pathBase = "/";
    try {
      // Try to create URL from BASE_URL
      const siteBaseURL = new URL(BASE_URL, window.location.origin);
      pathBase = siteBaseURL.pathname;
    } catch (e) {
      // If BASE_URL is not a valid URL, treat it as a path
      pathBase = BASE_URL.startsWith('/') ? BASE_URL : '/' + BASE_URL;
    }
    
    const pathWindow = window.location.pathname;
    const isHome = pathBase === pathWindow || pathWindow === "/" || pathWindow === pathBase || pathWindow === pathBase + "/";

    const drawGlobal = isHome && {{.Site.Data.graphConfig.enableGlobalGraph | default false}};
    const graphConfig = drawGlobal ? {{.Site.Data.graphConfig.globalGraph | jsonify}} : {{.Site.Data.graphConfig.localGraph | jsonify}};
    const pathColors = {{.Site.Data.graphConfig.paths | default (slice) | jsonify}};

    const baseUrlPath = {{strings.TrimRight "/" .Site.BaseURL | jsonify}};

    drawGraph(
      baseUrlPath,
      drawGlobal,
      pathColors,
      graphConfig,
      fetchData
    );
  };

  // Initialize graph on page load
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', () => {
      setTimeout(renderGraph, 100);
    });
  } else {
    setTimeout(renderGraph, 100);
  }
</script>
